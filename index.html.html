<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Tierlist</title>
  <style>
    body { background:#0b1020; color:#e6edf3; font-family: system-ui, sans-serif; margin:0; }
    .wrap { display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; overflow:hidden; margin:20px; width:240px }
    .poster { width:100%; aspect-ratio:2/3; background:#0a0f1f; display:flex; align-items:center; justify-content:center }
    .poster img { width:100%; height:100%; object-fit:cover; display:block }
    .meta { padding:10px; font-size:14px }
    .meta .actions { display:flex; gap:8px; margin-top:8px }

    .board { margin:20px; flex:1; min-width:320px }
    .tiers { display:flex; flex-direction:column; gap:10px }
    .row { display:grid; grid-template-columns:72px 1fr; gap:8px; align-items:start }
    .lane { display:flex; gap:6px; flex-wrap:wrap; min-height:90px; border:1px dashed #334155; border-radius:8px; padding:6px }
    .lane.dragover { outline:2px solid rgba(96,165,250,.5) }
    .label { height:90px; display:flex; align-items:center; justify-content:center; font-weight:bold; border-radius:8px; }
    .S { background:#10b981 }.A{background:#22c55e}.B{background:#84cc16}.C{background:#f59e0b}.D{background:#f97316}.F{background:#ef4444}.X{background:#94a3b8}
    .label span { color:#0b1020 }

    .mini { width:60px; cursor:grab }
    .mini:active{ cursor:grabbing }
    .mini .thumb { width:60px; height:90px; border-radius:6px; overflow:hidden; border:1px solid #334155; background:#0a0f1f }
    .mini img { width:100%; height:100%; object-fit:cover; display:block }
    .title { font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:center; margin-top:2px }

    .help { color:#9fb0c2; margin:0 20px }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="current" class="card" draggable="true" aria-grabbed="false">
      <div class="poster" id="poster"><span class="help">Loading…</span></div>
      <div class="meta">
        <strong id="title">—</strong> (<span id="year">—</span>)
        <div id="genres"></div>
        <div class="actions">
          <button id="skip">Didn't Watch</button>
          <button id="next">Next ▶</button>
          <button id="undo">Undo</button>
        </div>
        <div id="status" class="help"></div>
      </div>
    </div>

    <div class="board">
      <p class="help">Tip: drag the big poster into a lane. You can also drag the small posters between and within lanes to re-order.</p>
      <div class="tiers">
        <div class="row"><div class="label S"><span>S</span></div><div class="lane" data-tier="S"></div></div>
        <div class="row"><div class="label A"><span>A</span></div><div class="lane" data-tier="A"></div></div>
        <div class="row"><div class="label B"><span>B</span></div><div class="lane" data-tier="B"></div></div>
        <div class="row"><div class="label C"><span>C</span></div><div class="lane" data-tier="C"></div></div>
        <div class="row"><div class="label D"><span>D</span></div><div class="lane" data-tier="D"></div></div>
        <div class="row"><div class="label F"><span>F</span></div><div class="lane" data-tier="F"></div></div>
        <div class="row"><div class="label X"><span>Didn't<br/>Watch</span></div><div class="lane" data-tier="X"></div></div>
      </div>
    </div>
  </div>

  <script>
    // --- Data ---
    const MOVIES = [
      {id:1,title:"Inception",year:2010,genres:["Sci-Fi","Thriller"]},
      {id:2,title:"The Dark Knight",year:2008,genres:["Action","Drama"]},
      {id:3,title:"Parasite",year:2019,genres:["Thriller","Drama"]},
      {id:4,title:"Interstellar",year:2014,genres:["Sci-Fi","Drama"]},
    ];

    // --- Elements ---
    const els = {
      poster: document.getElementById('poster'),
      title: document.getElementById('title'),
      year: document.getElementById('year'),
      genres: document.getElementById('genres'),
      skip: document.getElementById('skip'),
      next: document.getElementById('next'),
      undo: document.getElementById('undo'),
      current: document.getElementById('current'),
      status: document.getElementById('status'),
      lanes: [...document.querySelectorAll('.lane')],
    };

    // --- State ---
    let placements = load('placements') || {}; // {movieId: tier}
    let order = load('order') || {};           // {tier: [movieIds]}
    let skipped = load('skipped') || [];       // [movieId]
    let history = [];                          // for Undo

    let pool = [];                             // filtered pool (here: all not placed/skipped)
    let currentId = null;                      // currently shown movie id

    // --- Helpers ---
    function save(k,v){ localStorage.setItem('tier_'+k, JSON.stringify(v)); }
    function load(k){ try { return JSON.parse(localStorage.getItem('tier_'+k)); } catch { return null; } }

    function posterData(text,w=240,h=360){
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'>
        <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
          <stop offset='0%' stop-color='#0b1327'/><stop offset='100%' stop-color='#12203a'/>
        </linearGradient></defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <rect x='8' y='8' width='${w-16}' height='${h-16}' rx='12' ry='12' fill='none' stroke='#1f2937' stroke-width='2'/>
        <foreignObject x='16' y='16' width='${w-32}' height='${h-32}'>
          <div xmlns='http://www.w3.org/1999/xhtml' style='display:flex;align-items:center;justify-content:center;width:100%;height:100%;text-align:center;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; font-size:${Math.max(12, Math.min(22, w/11))}px; line-height:1.15; color:#cbd5e1; padding:10px;'>${text}</div>
        </foreignObject>
      </svg>`;
      return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
    }

    function buildPool(){
      const allIds = MOVIES.map(m=>m.id);
      pool = allIds.filter(id => !placements[id] && !skipped.includes(id));
      if(pool.length===0 && skipped.length>0){
        pool = skipped.splice(0, skipped.length);
        save('skipped', skipped);
        els.status.textContent = 'Recycled skipped movies so you can keep going.';
      }
    }

    function pickNext(){
      if(pool.length===0) buildPool();
      if(pool.length===0){ renderEmpty(); return; }
      currentId = pool.shift();
      renderCurrent();
    }

    function renderCurrent(){
      const m = MOVIES.find(x=>x.id===currentId);
      if(!m){ renderEmpty(); return; }
      els.poster.innerHTML = '';
      const img = document.createElement('img');
      img.alt = m.title + ' poster';
      img.src = posterData(m.title, 240, 360);
      els.poster.appendChild(img);
      els.title.textContent = m.title;
      els.year.textContent = m.year;
      els.genres.textContent = m.genres.join(', ');
      els.current.setAttribute('draggable','true');
      els.status.textContent = '';
    }

    function renderEmpty(){
      els.poster.innerHTML = '<span class="help">Nothing to show. Click Next or Undo, or Reset via your browser storage.</span>';
      els.title.textContent = '—';
      els.year.textContent = '—';
      els.genres.textContent = '';
      currentId = null;
    }

    function miniCard(m){
      const d = document.createElement('div');
      d.className='mini';
      d.dataset.id = m.id;
      d.setAttribute('draggable','true');
      const p = document.createElement('div');
      p.className='thumb';
      const img = document.createElement('img');
      img.src=posterData(m.title,60,90);
      img.alt=m.title;
      p.appendChild(img);
      d.appendChild(p);
      const t = document.createElement('div');
      t.className='title';
      t.textContent=m.title;
      d.appendChild(t);
      return d;
    }

    function ensureTierArray(tier){ if(!order[tier]) order[tier]=[]; }

    function place(id,tier, index = null){
      const m = MOVIES.find(x=>x.id===id); if(!m) return;
      ensureTierArray(tier);

      const prevTier = placements[id];
      if(prevTier){
        order[prevTier] = (order[prevTier]||[]).filter(x=>x!==id);
      }

      placements[id] = tier;
      if(index===null || index>order[tier].length) order[tier].push(id); else order[tier].splice(index,0,id);

      save('placements', placements); save('order', order);

      mountPlacements();
      history.push({type:'place', id, from: prevTier, to:tier});
    }

    function mountPlacements(){
      els.lanes.forEach(l=>l.innerHTML='');  
      Object.entries(order).forEach(([tier, ids])=>{
        const lane = document.querySelector(\`.lane[data-tier="\${tier}"]\`);
        ids.forEach(id=>{
          const m = MOVIES.find(x=>x.id===id);
          if(m) lane.appendChild(miniCard(m));
        });
      });
    }

    // --- Drag logic ---
    els.current.addEventListener('dragstart', e=>{
      if(currentId==null) { e.preventDefault(); return; }
      e.dataTransfer.setData('text/plain', JSON.stringify({type:'current', id: currentId}));
    });

    document.addEventListener('dragstart', e=>{
      const mini = e.target.closest('.mini');
      if(mini){
        const id = Number(mini.dataset.id);
        e.dataTransfer.setData('text/plain', JSON.stringify({type:'mini', id}));
      }
    });

    function laneInsertIndex(lane, clientX){
      const minis = [...lane.querySelectorAll('.mini')];
      for(let i=0;i<minis.length;i++){
        const rect = minis[i].getBoundingClientRect();
        if(clientX < rect.left + rect.width/2) return i;
      }
      return minis.length;
    }

    els.lanes.forEach(l=>{
      l.addEventListener('dragover', e=>{ e.preventDefault(); l.classList.add('dragover'); });
      l.addEventListener('dragleave', ()=> l.classList.remove('dragover'));
      l.addEventListener('drop', e=>{
        e.preventDefault(); l.classList.remove('dragover');
        let data; 
        try{ data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch { return; }
        const tier = l.dataset.tier;
        const insertAt = laneInsertIndex(l, e.clientX);
        if(data.type==='current' && currentId!=null){
          place(currentId, tier, insertAt);
          pickNext();
        } else if(data.type==='mini'){
          place(Number(data.id), tier, insertAt);
        }
      });
    });

    // --- Controls ---
    els.skip.addEventListener('click', ()=>{ if(currentId!=null){ place(currentId,'X'); pickNext(); } });
    els.next.addEventListener('click', pickNext);
    els.undo.addEventListener('click', ()=>{
      const last = history.pop(); if(!last) return;
      if(last.type==='place'){
        if(last.from){
          place(last.id, last.from);
        } else {
          delete placements[last.id];
          save('placements',placements);
          mountPlacements();
        }
      }
    });

    // --- Init ---
    function init(){
      if(Object.keys(order).length===0 && Object.keys(placements).length>0){
        Object.entries(placements).forEach(([id,tier])=>{
          ensureTierArray(tier);
          order[tier].push(Number(id));
        });
      }
      mountPlacements();
      buildPool();
      pickNext();
    }
    init();

    // --- Tests (console) ---
    console.assert(MOVIES.length>0, 'Movies should not be empty');
    const pd = posterData('Test'); console.assert(typeof pd==='string' && pd.startsWith('data:image/svg+xml'), 'posterData returns data URI');
    (function testSkip(){
      const before = (order['X']||[]).length; const savedId = currentId; els.skip.click();
      const after = (order['X']||[]).length; console.assert(after===before+1, 'Skip puts movie into X tier');
      els.undo.click(); if(savedId!=null){ currentId = savedId; renderCurrent(); }
    })();
  </script>
</body>
</html>
